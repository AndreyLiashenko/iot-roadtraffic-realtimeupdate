<!DOCTYPE html>
<html>
<head>
    <title>Smart City Traffic Map</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: #0f172a; }
        #map { height: 100vh; width: 100vw; }
        .controls { position: absolute; top: 20px; left: 20px; z-index: 1000; background: rgba(15, 23, 42, 0.9); padding: 15px; border-radius: 8px; color: white; width: 220px; }
        button { width: 100%; padding: 10px; margin: 5px 0; background: #334155; border: none; color: white; cursor: pointer; border-radius: 4px; }
        button.active { background: #2563eb; }
        button.brain { background: linear-gradient(45deg, #ec4899, #8b5cf6); font-weight: bold; margin-top: 15px; }
    </style>
</head>
<body>

<div class="controls">
    <h3>Traffic Source</h3>
    <button onclick="switchSource(5001, this)">Exponential Smoothing</button>
    <button onclick="switchSource(5002, this)">DB Baseline</button>
    <button onclick="switchSource(5003, this)">Sliding Window</button>
    <button onclick="switchSource(5004, this)" class="active">Fuzzy AI</button>
    
    <button class="brain" onclick="window.open('http://localhost:5004/monitor', '_blank')">üß† Open AI Monitor</button>
    <button class="brain" onclick="window.open('http://localhost:5004/monitor3d', '_blank')">üìê Open 3D Universe</button>
</div>

<div id="map"></div>

<script>
    const map = L.map('map').setView([50.55, 30.22], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: 'CARTO' }).addTo(map);
    L.svg().addTo(map);
    const g = d3.select(map.getPanes().overlayPane).select("svg").append("g").attr("class", "leaflet-zoom-hide");
    
    let currentPort = 5004;
    const colorScale = d3.scaleLinear().domain([0, 15, 40]).range(["#ef4444", "#eab308", "#22c55e"]);

    function update() {
        fetch(`http://localhost:${currentPort}/graph`).then(r => r.json()).then(data => {
            const nodes = {}; data.nodes.forEach(n => nodes[n.id] = n);
            const proj = (lat, lon) => map.latLngToLayerPoint([lat, lon]);
            const line = d3.line().x(d => d.x).y(d => d.y);

            const paths = g.selectAll("path").data(data.edges, d => d.source+"-"+d.target);
            paths.enter().append("path").merge(paths)
                .attr("d", d => {
                    const p1 = proj(nodes[d.source].lat, nodes[d.source].lon);
                    const p2 = proj(nodes[d.target].lat, nodes[d.target].lon);
                    return line([{x: p1.x, y: p1.y}, {x: p2.x, y: p2.y}]);
                })
                .attr("stroke", d => colorScale(Math.max(0, d.speed)))
                .attr("stroke-width", 3).attr("fill", "none").attr("opacity", 0.8);
            paths.exit().remove();
        });
    }

    function switchSource(port, btn) {
        currentPort = port;
        document.querySelectorAll('button:not(.brain)').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    map.on("zoomend", update);
    setInterval(update, 1000);
    update(); // Init
</script>
</body>
</html>