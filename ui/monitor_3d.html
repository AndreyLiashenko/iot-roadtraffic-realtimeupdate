<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adaptive Traffic Phase Space</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root { 
            --bg: #0d1117; 
            --panel: #161b22; 
            --border: #30363d; 
            --text: #c9d1d9; 
            --muted: #8b949e; 
            --accent: #58a6ff; 
            --font: 'SF Mono', 'Segoe UI Mono', 'Roboto Mono', monospace;
        }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        
        #container { display: flex; height: 100vh; }
        #chart { flex: 1; min-width: 0; } /* min-width fix for flex items */
        
        #sidebar { 
            width: 380px; 
            background: var(--panel); 
            border-left: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .header { 
            padding: 20px; 
            border-bottom: 1px solid var(--border); 
            font-weight: 700; 
            font-size: 1.1em;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            background: #21262d;
        }
        
        .live-indicator { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 0.8em; 
            color: var(--muted); 
            font-family: var(--font);
        }
        .live-dot { 
            width: 8px; height: 8px; 
            background: #238636; 
            border-radius: 50%; 
            box-shadow: 0 0 8px #238636; 
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        #cluster-list { flex: 1; overflow-y: auto; padding: 15px; }
        
        /* Scrollbar styling */
        #cluster-list::-webkit-scrollbar { width: 8px; }
        #cluster-list::-webkit-scrollbar-track { background: var(--bg); }
        #cluster-list::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        #cluster-list::-webkit-scrollbar-thumb:hover { background: #8b949e; }

        .card { 
            background: #21262d; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 12px; 
            position: relative; 
            transition: all 0.2s ease;
            overflow: hidden;
        }
        
        .card:hover { 
            border-color: var(--accent); 
            transform: translateX(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Status colors strip */
        .card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        
        .status-GRIDLOCK::before { background: #da3633; box-shadow: 2px 0 8px rgba(218, 54, 51, 0.4); }
        .status-CONGESTED::before { background: #d29922; }
        .status-FREE_FLOW::before { background: #238636; box-shadow: 2px 0 8px rgba(35, 134, 54, 0.4); }
        .status-STABLE::before { background: #1f6feb; }
        .status-BRAKING::before { background: #ff7b72; }
        .status-RECOVERING::before { background: #3fb950; }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .regime-title { font-family: var(--font); font-weight: 700; color: #fff; font-size: 1.1em; }
        .badge { 
            padding: 3px 8px; 
            border-radius: 12px; 
            font-size: 10px; 
            font-weight: 800; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(48, 54, 61, 0.5);
            border: 1px solid var(--border);
        }

        .meta-badges { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
        .meta-tag { 
            font-size: 10px; 
            padding: 2px 6px; 
            border-radius: 4px; 
            background: #0d1117; 
            border: 1px solid var(--border);
            color: var(--muted);
            font-family: var(--font);
        }
        .merged { color: #a371f7; border-color: rgba(163, 113, 247, 0.3); }
        .new { color: #f2cc60; border-color: rgba(242, 204, 96, 0.3); }

        .stats-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 8px 15px; 
            font-size: 12px; 
        }
        
        .stat-row { display: flex; justify-content: space-between; align-items: center; }
        .stat-label { color: var(--muted); }
        .stat-val { font-family: var(--font); font-weight: 600; color: var(--text); }
        
        .up { color: #3fb950; } 
        .down { color: #ff7b72; }
        .alpha-low { color: #58a6ff; } 
        .alpha-mid { color: #d29922; }
        .alpha-high { color: #da3633; font-weight: 800; }

        .no-data { text-align: center; color: var(--muted); margin-top: 50px; font-style: italic; }
    </style>
</head>
<body>

<div id="container">
    <div id="chart"></div>
    <div id="sidebar">
        <div class="header">
            <span>Regime Monitor</span>
            <div class="live-indicator"><div class="live-dot"></div> LIVE</div>
        </div>
        <div id="cluster-list">
            <div class="no-data">Waiting for clustering data...</div>
        </div>
    </div>
</div>

<script>
    let currentData = null;
    let isFirstLoad = true;

    // Advanced Regime Classification Logic
    function analyzeRegime(eff, load, trend) {
        // Absolute Gridlock: High load, zero movement
        if (load > 2.0) return { label: 'DEADLOCK', class: 'status-GRIDLOCK' };
        if (eff < 0.15) return { label: 'STALLED', class: 'status-GRIDLOCK' };
        
        // Heavy Traffic
        if (load > 1.0) return { label: 'SATURATED', class: 'status-CONGESTED' };
        if (eff < 0.50) return { label: 'SLOW', class: 'status-CONGESTED' };
        
        // Dynamics
        if (trend < -0.1) return { label: 'BRAKING', class: 'status-BRAKING' };
        if (trend > 0.1) return { label: 'RECOVERING', class: 'status-RECOVERING' };
        
        // Good conditions
        if (eff > 0.80 && load < 0.6) return { label: 'FREE FLOW', class: 'status-FREE_FLOW' };
        
        return { label: 'STABLE', class: 'status-STABLE' };
    }

    // 3D Chart Configuration
    const layout = {
        paper_bgcolor: '#0d1117',
        plot_bgcolor: '#0d1117',
        margin: {l:0, r:0, b:0, t:0},
        scene: {
            // Y Axis (Efficiency): Fixed 0-1.1 because it's normalized
            yaxis: {
                title: 'EFFICIENCY (Speed/Limit)', 
                range: [0, 1.1], 
                gridcolor: '#30363d', 
                zerolinecolor: '#8b949e',
                tickfont: {color: '#8b949e', family: 'monospace'}
            },
            // X Axis (Load): AUTO SCALE (Removed range:[0,5])
            xaxis: {
                title: 'LOAD FACTOR', 
                gridcolor: '#30363d', 
                zerolinecolor: '#8b949e',
                tickfont: {color: '#8b949e', family: 'monospace'}
            },
            // Z Axis (Trend): AUTO SCALE (Removed range)
            zaxis: {
                title: 'TREND (Accel)', 
                gridcolor: '#30363d', 
                zerolinecolor: '#8b949e',
                tickfont: {color: '#8b949e', family: 'monospace'}
            },
            // Camera setup
            camera: {
                eye: {x: 1.8, y: 0.5, z: 0.8}, // Better angle to see depth
                up: {x: 0, y: 1, z: 0}
            },
            aspectmode: 'cube', // Keeps the box cubic, prevents flattening
            annotations: []
        }, 
        showlegend: false,
        hovermode: 'closest'
    };

    function highlight(idx) {
        if (!currentData || !currentData.centers.length) return;
        
        // Dim others, highlight target
        const opacities = new Array(currentData.centers.length).fill(idx === -1 ? 0.65 : 0.1);
        if (idx !== -1) opacities[idx] = 1.0;
        
        // Also scale up the highlighted one slightly
        // Note: Plotly restyle is heavy, use carefully
        Plotly.restyle('chart', {'marker.opacity': [opacities]});
    }

    async function update() {
        try {
            const r = await fetch('/clusters');
            const data = await r.json();
            currentData = data;

            if(!data.centers || !data.centers.length) {
                document.getElementById('cluster-list').innerHTML = '<div class="no-data">No active regimes found.<br>Waiting for traffic...</div>';
                return;
            }

            const {centers, weights, sigmas, alphas, merge_counts:merges, ages} = data;
            
            // Map coordinates (Y=Efficiency, X=Load, Z=Trend)
            const x = centers.map(c => c[1]); // Load
            const y = centers.map(c => c[0]); // Eff
            const z = centers.map(c => c[2]); // Trend
            
            // Calculate sizes based on Sigma magnitude
            // Adjusted multiplier: 50 instead of 120 to avoid giant bubbles
            const sizes = sigmas.map(s => {
                const magnitude = Math.sqrt(s[0]**2 + s[1]**2 + s[2]**2);
                return 10 + magnitude * 50; 
            });
            
            // Colors: Green (High Eff) -> Red (Low Eff)
            const colors = y; 

            const labels = centers.map((_, i) => `Regime #${i}`);

            // 3D Annotations (Floating text labels)
            const annotations = centers.map((c, i) => ({
                x: c[1], y: c[0], z: c[2],
                text: i.toString(),
                xanchor: 'center', yanchor: 'middle',
                showarrow: false,
                font: { color: '#0d1117', size: 12, family: 'monospace', weight: 'bold' },
                bgcolor: '#ffffff',
                borderpad: 2,
                opacity: 0.8,
                captureevents: true
            }));

            const newLayout = { ...layout };
            newLayout.scene.annotations = annotations;
            
            // Camera persistence
            if (!isFirstLoad) {
                const gd = document.getElementById('chart');
                if (gd && gd.layout && gd.layout.scene) {
                    newLayout.scene.camera = gd.layout.scene.camera;
                }
            }

            Plotly.react('chart', [{
                type: 'scatter3d', 
                mode: 'markers',
                x: x, y: y, z: z,
                text: labels, 
                marker: { 
                    size: sizes, 
                    color: colors, 
                    colorscale: [[0, '#da3633'], [0.4, '#d29922'], [1, '#238636']], 
                    opacity: 0.65, // More transparent to see overlapping
                    sizemode: 'diameter',
                    line: { color: 'rgba(255,255,255,0.3)', width: 1 }
                },
                hovertemplate: 
                    '<b style="font-size:14px;color:#58a6ff">Regime #%{text}</b><br>' +
                    'Efficiency: %{y:.1%}<br>' +
                    'Load Factor: %{x:.2f}<br>' +
                    'Trend: %{z:+.4f}<extra></extra>'
            }], newLayout);

            renderSidebar(centers, weights, sigmas, alphas, merges, ages);
            isFirstLoad = false;

        } catch (e) {
            console.error("Update failed", e);
        }
    }

    function renderSidebar(centers, weights, sigmas, alphas, merges, ages) {
        const list = document.getElementById('cluster-list');
        list.innerHTML = '';
        
        const items = centers.map((c,i)=>({
            id:i, eff:c[0], load:c[1], trend:c[2], 
            w:weights[i], m:merges[i], age:ages[i], 
            alpha: alphas[i], 
            sigmaVec: sigmas[i]
        }));
        
        // Sort by Load Factor desc (Problematic first)
        items.sort((a,b) => b.load - a.load);

        items.forEach(it => {
            const st = analyzeRegime(it.eff, it.load, it.trend);
            
            let trendHtml = `<span class="stat-val">${it.trend.toFixed(4)}</span>`;
            if(it.trend > 0.01) trendHtml = `<span class="stat-val up">‚ñ≤ ${it.trend.toFixed(3)}</span>`;
            if(it.trend < -0.01) trendHtml = `<span class="stat-val down">‚ñº ${it.trend.toFixed(3)}</span>`;
            
            let meta = '';
            if(it.m > 0) meta += `<div class="meta-tag merged">üîó Merges: ${it.m}</div>`;
            if(it.age < 60 && it.m === 0) meta += `<div class="meta-tag new">‚ú® New Detection</div>`;
            meta += `<div class="meta-tag">‚è≥ ${it.age.toFixed(0)}s ago</div>`;

            const sigmaMag = Math.sqrt(it.sigmaVec[0]**2 + it.sigmaVec[1]**2 + it.sigmaVec[2]**2);
            
            let alphaClass = '';
            if(it.alpha < 0.2) alphaClass = 'alpha-low';
            else if(it.alpha > 0.6) alphaClass = 'alpha-high';
            else alphaClass = 'alpha-mid';

            const div = document.createElement('div');
            div.className = `card ${st.class}`;
            div.onmouseenter = () => highlight(it.id);
            div.onmouseleave = () => highlight(-1);
            
            div.innerHTML = `
                <div class="card-header">
                    <span class="regime-title">Regime #${it.id}</span>
                    <span class="badge" style="color:${st.class.includes('FREE') ? '#3fb950' : '#fff'}">${st.label}</span>
                </div>
                <div class="meta-badges">${meta}</div>
                <div class="stats-grid">
                    <div class="stat-row">
                        <span class="stat-label">Efficiency</span>
                        <span class="stat-val">${(it.eff*100).toFixed(1)}%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Load</span>
                        <span class="stat-val">${it.load.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Trend</span>
                        ${trendHtml}
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Weight</span>
                        <span class="stat-val">${it.w.toFixed(0)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Stability (Œ±)</span>
                        <span class="stat-val ${alphaClass}">${it.alpha.toFixed(3)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Spread (œÉ)</span>
                        <span class="stat-val">${sigmaMag.toFixed(2)}</span>
                    </div>
                </div>`;
            list.appendChild(div);
        });
    }

    setInterval(update, 2000);
    update();
</script>
</body>
</html>